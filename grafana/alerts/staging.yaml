apiVersion: 1
groups:
  - orgId: 1
    name: Bmad Core Observability
    folder: Operações
    interval: 1m
    rules:
      - uid: playbook-error-rate
        title: PlaybookErrorRate
        condition: C
        data:
          - refId: A
            queryType: PromQL
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: prometheus-staging
            model:
              expr: |
                sum(rate(http_server_duration_count{service_name="bmad-core-service", http_response_status_code=~"5..", deployment_environment="staging"}[5m]))
              instant: true
              interval: ""
              intervalMs: 60000
              legendFormat: ""
              maxDataPoints: 43200
          - refId: B
            queryType: PromQL
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: prometheus-staging
            model:
              expr: |
                sum(rate(http_server_duration_count{service_name="bmad-core-service", deployment_environment="staging"}[5m]))
              instant: true
              interval: ""
              intervalMs: 60000
              legendFormat: ""
              maxDataPoints: 43200
          - refId: C
            expression: B > 250 and (A / B) > 0.008
            type: math
            datasourceUid: __expr__
        labels:
          team: sre
          playbook: platform
          environment: staging
          severity: critical
        annotations:
          summary: "Erro 5xx acima de 0,8% com mais de 250 requisições"
          runbook_url: "https://github.com/bmad-method/Bmad-Method-v3/blob/main/quality/observability/runbooks/critical-alerts.md"
        for: 5m
        noDataState: Alerting
        execErrState: Alerting
      - uid: latency-slo-breach
        title: LatencySloBreach
        condition: C
        data:
          - refId: A
            queryType: PromQL
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: prometheus-staging
            model:
              expr: |
                histogram_quantile(0.95, sum(rate(http_server_duration_bucket{service_name="bmad-core-service", deployment_environment="staging"}[5m])) by (le))
              instant: true
              interval: ""
              intervalMs: 60000
              legendFormat: ""
              maxDataPoints: 43200
          - refId: C
            expression: A > 0.45
            type: math
            datasourceUid: __expr__
        labels:
          team: sre
          playbook: latency
          environment: staging
          severity: critical
        annotations:
          summary: "Latência P95 acima de 450 ms por 5 minutos"
          runbook_url: "https://github.com/bmad-method/Bmad-Method-v3/blob/main/quality/observability/runbooks/critical-alerts.md"
        for: 5m
        noDataState: Alerting
        execErrState: Alerting
      - uid: pipeline-failure-burst
        title: PipelineFailureBurst
        condition: C
        data:
          - refId: A
            queryType: PromQL
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: prometheus-staging
            model:
              expr: |
                increase(ci_pipeline_failures_total{pipeline="staging"}[10m])
              instant: true
              interval: ""
              intervalMs: 60000
              legendFormat: ""
              maxDataPoints: 43200
          - refId: C
            expression: A >= 3
            type: math
            datasourceUid: __expr__
        labels:
          team: devops
          playbook: ci
          environment: staging
          severity: critical
        annotations:
          summary: "Pipelines falharam 3 vezes ou mais nos últimos 10 minutos"
          runbook_url: "https://github.com/bmad-method/Bmad-Method-v3/blob/main/quality/observability/runbooks/critical-alerts.md"
        for: 3m
        noDataState: NoData
        execErrState: Alerting
      - uid: engagement-drop
        title: EngagementDrop
        condition: C
        data:
          - refId: A
            queryType: PromQL
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: prometheus-staging
            model:
              expr: |
                sum(increase(bmad_web_page_view_total{deployment_environment="staging"}[30m]))
              instant: true
              interval: ""
              intervalMs: 60000
              legendFormat: ""
              maxDataPoints: 43200
          - refId: B
            queryType: PromQL
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: prometheus-staging
            model:
              expr: |
                sum(increase(bmad_web_page_view_total{deployment_environment="staging"}[1h])) / 2
              instant: true
              interval: ""
              intervalMs: 60000
              legendFormat: ""
              maxDataPoints: 43200
          - refId: C
            expression: B > 0 and (A < (B * 0.75))
            type: math
            datasourceUid: __expr__
        labels:
          team: product-ops
          playbook: engagement
        annotations:
          summary: "Queda de 25% no engajamento web vs média da última hora"
          runbook_url: "https://github.com/bmad-method/Bmad-Method-v3/blob/main/quality/observability/runbooks/critical-alerts.md"
        for: 4m
        noDataState: NoData
        execErrState: Alerting
      - uid: availability-drop
        title: AvailabilityDrop
        condition: D
        data:
          - refId: A
            queryType: PromQL
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: prometheus-staging
            model:
              expr: |
                sum(increase(http_server_duration_count{service_name="bmad-core-service", http_response_status_code=~"5..", deployment_environment="staging"}[10m]))
              instant: true
              interval: ""
              intervalMs: 60000
              legendFormat: ""
              maxDataPoints: 43200
          - refId: B
            queryType: PromQL
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: prometheus-staging
            model:
              expr: |
                sum(increase(http_server_duration_count{service_name="bmad-core-service", deployment_environment="staging"}[10m]))
              instant: true
              interval: ""
              intervalMs: 60000
              legendFormat: ""
              maxDataPoints: 43200
          - refId: C
            expression: B > 400
            type: math
            datasourceUid: __expr__
          - refId: D
            expression: C and (1 - (A / B)) < 0.997
            type: math
            datasourceUid: __expr__
        labels:
          team: sre
          playbook: availability
          environment: staging
          severity: critical
        annotations:
          summary: "Disponibilidade abaixo de 99.7% com pelo menos 400 requisições em 10 minutos"
          runbook_url: "https://github.com/bmad-method/Bmad-Method-v3/blob/main/quality/observability/runbooks/critical-alerts.md"
        for: 10m
        noDataState: NoData
        execErrState: Alerting
receivers:
  - name: staging-critical
    slack_configs:
      - channel: "#incident"
        title: "[Observability] {{ .CommonLabels.alertname }}"
        text: "{{ .CommonAnnotations.summary }}"
        send_resolved: true
    pagerduty_configs:
      - service_key: "{{ pagerduty.BmadPlatformStaging }}"
        severity: critical
        description: "{{ .CommonLabels.alertname }} em {{ .CommonLabels.playbook }}"
policies:
  - orgId: 1
    receiver: staging-critical
    routes:
      - matchers:
          - "team=sre"
        receiver: staging-critical
      - matchers:
          - "team=devops"
        receiver: staging-critical
      - matchers:
          - "team=product-ops"
        receiver: staging-critical
