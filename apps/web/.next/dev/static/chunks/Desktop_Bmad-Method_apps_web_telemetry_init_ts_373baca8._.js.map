{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jdc/Desktop/Bmad-Method/apps/web/telemetry/init.ts"],"sourcesContent":["import { diag, DiagConsoleLogger, DiagLogLevel, trace } from '@opentelemetry/api';\r\nimport { logs } from '@opentelemetry/api-logs';\r\nimport { resourceFromAttributes } from '@opentelemetry/resources';\r\nimport type { Resource } from '@opentelemetry/resources';\r\nimport { registerInstrumentations } from '@opentelemetry/instrumentation';\r\nimport { FetchInstrumentation } from '@opentelemetry/instrumentation-fetch';\r\nimport { LoggerProvider, BatchLogRecordProcessor } from '@opentelemetry/sdk-logs';\r\nimport { OTLPLogExporter } from '@opentelemetry/exporter-logs-otlp-http';\r\nimport { MeterProvider, PeriodicExportingMetricReader } from '@opentelemetry/sdk-metrics';\r\nimport { OTLPMetricExporter } from '@opentelemetry/exporter-metrics-otlp-http';\r\nimport { WebTracerProvider } from '@opentelemetry/sdk-trace-web';\r\nimport { BatchSpanProcessor } from '@opentelemetry/sdk-trace-base';\r\nimport { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http';\r\n\r\nexport type TelemetryRuntime = {\r\n  tracerProvider: WebTracerProvider;\r\n  meterProvider: MeterProvider;\r\n  loggerProvider: LoggerProvider;\r\n};\r\n\r\ntype EndpointKind = 'traces' | 'metrics' | 'logs';\r\n\r\nfunction buildUrl(kind: EndpointKind, base: string) {\r\n  const normalized = base.replace(/\\/$/, '');\r\n  if (normalized.endsWith(`/v1/${kind}`)) {\r\n    return normalized;\r\n  }\r\n  return `${normalized}/v1/${kind}`;\r\n}\r\n\r\nfunction isTelemetryDisabled(flag?: string | null) {\r\n  if (!flag) {\r\n    return false;\r\n  }\r\n  const normalized = flag.trim().toLowerCase();\r\n  return ['0', 'false', 'no', 'off'].includes(normalized);\r\n}\r\n\r\nfunction sanitizeEndpoint(raw?: string | null) {\r\n  const trimmed = raw?.trim();\r\n  return trimmed ? trimmed : undefined;\r\n}\r\n\r\nfunction parseHeaders(raw?: string) {\r\n  if (!raw) {\r\n    return {} as Record<string, string>;\r\n  }\r\n  return raw.split(',').reduce((headers, entry) => {\r\n    const [key, value] = entry.split('=');\r\n    if (key && value) {\r\n      headers[key.trim()] = value.trim();\r\n    }\r\n    return headers;\r\n  }, {} as Record<string, string>);\r\n}\r\n\r\nfunction createResource(): Resource {\r\n  return resourceFromAttributes({\r\n    'service.name': process.env.NEXT_PUBLIC_OTEL_SERVICE_NAME ?? 'bmad-web-app',\r\n    'service.namespace': process.env.NEXT_PUBLIC_OTEL_SERVICE_NAMESPACE ?? 'bmad.platform',\r\n    'deployment.environment': process.env.NEXT_PUBLIC_ENVIRONMENT ?? 'local',\r\n  });\r\n}\r\n\r\nexport async function initTelemetry(): Promise<TelemetryRuntime | null> {\r\n  if (typeof window === 'undefined') {\r\n    return null;\r\n  }\r\n\r\n  diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.ERROR);\r\n\r\n  if (isTelemetryDisabled(process.env.NEXT_PUBLIC_ENABLE_TELEMETRY)) {\r\n    console.info(\r\n      '[Telemetry] Telemetria desativada via NEXT_PUBLIC_ENABLE_TELEMETRY. Instrumentações não serão registradas.'\r\n    );\r\n    return null;\r\n  }\r\n\r\n  const baseEndpoint = sanitizeEndpoint(process.env.NEXT_PUBLIC_OTEL_EXPORTER_OTLP_ENDPOINT);\r\n  const headers = parseHeaders(process.env.NEXT_PUBLIC_OTEL_EXPORTER_OTLP_HEADERS);\r\n  const resource = createResource();\r\n\r\n  const tracerProvider = new WebTracerProvider({ resource });\r\n  if (baseEndpoint) {\r\n    tracerProvider.addSpanProcessor(\r\n      new BatchSpanProcessor(\r\n        new OTLPTraceExporter({ url: buildUrl('traces', baseEndpoint), headers })\r\n      )\r\n    );\r\n  } else {\r\n    console.info(\r\n      '[Telemetry] NEXT_PUBLIC_OTEL_EXPORTER_OTLP_ENDPOINT não definido; instrumentações serão registradas sem exportadores.'\r\n    );\r\n  }\r\n  tracerProvider.register();\r\n\r\n  const meterProvider = new MeterProvider({\r\n    resource,\r\n    readers: baseEndpoint\r\n      ? [\r\n          new PeriodicExportingMetricReader({\r\n            exporter: new OTLPMetricExporter({\r\n              url: buildUrl('metrics', baseEndpoint),\r\n              headers,\r\n            }),\r\n          }),\r\n        ]\r\n      : [],\r\n  });\r\n\r\n  const loggerProvider = new LoggerProvider({ resource });\r\n  if (baseEndpoint) {\r\n    loggerProvider.addLogRecordProcessor(\r\n      new BatchLogRecordProcessor(\r\n        new OTLPLogExporter({ url: buildUrl('logs', baseEndpoint), headers })\r\n      )\r\n    );\r\n  }\r\n  logs.setGlobalLoggerProvider(loggerProvider);\r\n\r\n  registerInstrumentations({\r\n    tracerProvider,\r\n    meterProvider,\r\n    instrumentations: [\r\n      new FetchInstrumentation({\r\n        propagateTraceHeaderCorsUrls: [\r\n          process.env.NEXT_PUBLIC_CORE_API_BASE_URL ?? 'http://localhost:8000',\r\n        ],\r\n      }),\r\n    ],\r\n  });\r\n\r\n  const meter = meterProvider.getMeter('bmad.web');\r\n  const counter = meter.createCounter('bmad_web_page_view_total', {\r\n    description: 'Total de visualizações de página registradas na sessão',\r\n  });\r\n  counter.add(1, { route: window.location.pathname });\r\n\r\n  const webLogger = loggerProvider.getLogger('bmad.web');\r\n  webLogger.emit({\r\n    severityText: 'INFO',\r\n    body: 'page_view',\r\n    attributes: {\r\n      route: window.location.pathname,\r\n      userAgent: window.navigator.userAgent,\r\n    },\r\n  });\r\n\r\n  trace.getTracer('bmad.web').startSpan('telemetry.initialized').end();\r\n\r\n  return { tracerProvider, meterProvider, loggerProvider };\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}